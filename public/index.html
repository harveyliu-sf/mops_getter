<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MOPS é—œéµå­—å…¬å‘Šç›£æ§</title>

  <!-- favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png" />

  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#e5e5e5;
      --card:#fafafa;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap{ max-width: 1100px; margin:0 auto; padding: 20px 14px 36px; }

    h1{ margin:0 0 6px; font-size: 20px; }
    .meta{ color: var(--muted); line-height: 1.6; font-size: 13px; margin-bottom: 12px; }

    .bar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin: 10px 0 12px;
    }

    .search{
      display:flex;
      align-items:center;
      gap:8px;
      flex: 1 1 360px;
      min-width: 240px;
      border:1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
    }

    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size: 14px;
      background: transparent;
      color: var(--text);
    }

    .pill{
      border:1px solid var(--border);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: #fff;
      white-space: nowrap;
    }

    /* Desktop table */
    table{
      width:100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
      background: #fff;
      box-shadow: var(--shadow);
    }

    th, td{
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      vertical-align: top;
      font-size: 13px;
    }

    th{
      background: #f7f7f7;
      text-align:left;
      position: sticky;
      top:0;
      z-index: 1;
    }

    tr:hover td{ background: #fcfcfc; }

    .company .id{ font-weight: 700; }
    .company .name{ color: var(--muted); font-size: 12px; margin-top: 2px; }
    .company .fetched{ color: #888; font-size: 11px; margin-top: 6px; }

    .tags{ display:flex; gap:6px; flex-wrap:wrap; }
    .tag{
      font-size: 12px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 3px 8px;
      border-radius: 999px;
      color: #333;
    }

    .btn{
      border: 1px solid var(--border);
      background: #fff;
      color: #111;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .btn:hover{ background: #f7f7f7; }

    /* Detail expanded row (full-width under the row) */
    .detail-row td{
      padding: 0;
      background: #fff;
      border-bottom: 1px solid var(--border);
    }

    .detail-box{
      margin: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      padding: 12px;
    }

    .detail-table{
      width:100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow:hidden;
    }
    .detail-table th, .detail-table td{
      border-bottom: 1px solid var(--border);
      padding: 10px;
      font-size: 13px;
      vertical-align: top;
    }
    .detail-table th{
      background: #f7f7f7;
      white-space: nowrap;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .empty{
      margin-top: 12px;
      padding: 14px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      color: var(--muted);
      background: #fff;
    }

    /* Mobile: switch to cards */
    .cards{ display:none; }
    .card{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      box-shadow: var(--shadow);
      padding: 12px;
      margin-bottom: 10px;
    }
    .card .top{
      display:flex; justify-content:space-between; gap:10px;
      align-items:flex-start;
    }
    .card .time{
      color: var(--muted);
      font-size: 12px;
      text-align:right;
      white-space: nowrap;
    }
    .card .subject{
      margin-top: 8px;
      font-size: 14px;
      line-height: 1.45;
    }
    .card .meta2{
      margin-top: 8px;
      color: #888;
      font-size: 11px;
    }
    .card details{
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      padding: 10px;
    }
    .card summary{
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .card details[open] summary{ margin-bottom: 10px; }

    /* Make detail content readable on small screens */
    .desc{
      white-space: pre-wrap;         /* keep newlines */
      word-break: break-word;
      line-height: 1.5;
      font-size: 13px;
      margin: 0;
    }

    @media (max-width: 820px){
      .main-table{ display:none; }
      .cards{ display:block; }
    }

    @media (max-width: 380px){
      h1{ font-size: 18px; }
      .search{ padding: 9px 10px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>MOPS é—œéµå­—å…¬å‘Šç›£æ§</h1>
    <div class="meta" id="meta">è®€å–ä¸­...</div>

    <div class="bar">
      <div class="search">
        <span style="color:#888;">ğŸ”</span>
        <input id="q" placeholder="æœå°‹ï¼šå…¬å¸ / ä¸»æ—¨ / é—œéµå­—ï¼ˆä¾‹ï¼šé´»æµ·ã€å…¬å¸å‚µï¼‰" />
      </div>
      <div class="pill" id="stat">â€”</div>
    </div>

    <!-- Desktop -->
    <table class="main-table">
      <thead>
        <tr>
          <th style="width:90px;">ç™¼è¨€æ—¥</th>
          <th style="width:80px;">æ™‚é–“</th>
          <th style="width:150px;">å…¬å¸</th>
          <th>ä¸»æ—¨</th>
          <th style="width:200px;">å‘½ä¸­é—œéµå­—</th>
          <th style="width:90px;">Detail</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <!-- Mobile -->
    <div class="cards" id="cards"></div>

    <div id="empty" class="empty" style="display:none;">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™ã€‚</div>
  </div>

<script>
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function safeGetDetailRow(detail) {
  // detail.result.data[0] expected
  try {
    const row = detail?.result?.data?.[0];
    if (Array.isArray(row) && row.length >= 10) return row;
  } catch (_) {}
  return null;
}

function speakerTextFromRow(row){
  const name = row?.[3] ?? "";
  const title = row?.[4] ?? "";
  const phone = row?.[5] ?? "";
  const s = `${name} ${title}ï¼ˆ${phone}ï¼‰`.replace(/\s+/g, " ").trim();
  return s || "â€”";
}

function descFromRow(row){
  const desc = row?.[9] ?? "";
  return String(desc);
}

function getFetchedTs(it) {
  const s = it?.fetched_at_tw;
  if (!s) return 0;
  const iso = s.replace(" ", "T") + "+08:00";
  const t = Date.parse(iso);
  return Number.isFinite(t) ? t : 0;
}

function makeTagsHtml(kws){
  const arr = Array.isArray(kws) ? kws : [];
  if (arr.length === 0) return '<span style="color:#888;">â€”</span>';
  return `<div class="tags">${arr.map(k => `<span class="tag">${escapeHtml(k)}</span>`).join("")}</div>`;
}

function buildDetailTableHtml(detail){
  const row = safeGetDetailRow(detail);
  if (!row) {
    return `<div style="color:#666;">ç„¡æ³•è§£æ detail çµæ§‹ï¼ˆè«‹æª¢æŸ¥ data.json çš„ detail.result.dataï¼‰</div>`;
  }
  const speaker = speakerTextFromRow(row);
  const desc = descFromRow(row);

  return `
    <table class="detail-table">
      <colgroup>
        <col style="width:30%">
        <col style="width:70%">
      </colgroup>
      <tr>
        <th>ç™¼è¨€äººï¼ˆé›»è©±ï¼‰</th>
        <th>èªªæ˜</th>
      </tr>
      <tr>
        <td>${escapeHtml(speaker)}</td>
        <td><pre class="desc">${escapeHtml(desc)}</pre></td>
      </tr>
    </table>
  `;
}

async function main() {
  const res = await fetch("./data.json", { cache: "no-store" });
  const data = await res.json();

  const meta = data.meta || {};
  let items = Array.isArray(data.items) ? data.items.slice() : [];

  // (2) sort: latest fetched first
  items.sort((a, b) => {
    const tb = getFetchedTs(b);
    const ta = getFetchedTs(a);
    if (tb !== ta) return tb - ta;
    return String(b?.key ?? "").localeCompare(String(a?.key ?? ""));
  });

  document.getElementById("meta").innerHTML =
    `åŸ·è¡Œæ™‚é–“ï¼ˆå°ç£ï¼‰ï¼š<span class="mono">${escapeHtml(meta.run_at_tw || "-")}</span>
    ã€€ï½œã€€æŸ¥è©¢ï¼š<span class="mono">${escapeHtml(JSON.stringify(meta.query || {}))}</span>
    ã€€ï½œã€€é—œéµå­—ï¼š<span class="mono">${escapeHtml((meta.keywords || []).join(", "))}</span>`;

  const q = document.getElementById("q");
  const tbody = document.getElementById("tbody");
  const cards = document.getElementById("cards");
  const empty = document.getElementById("empty");
  const stat = document.getElementById("stat");

  function filterItems(term){
    if (!term) return items;
    const t = term.toLowerCase();
    return items.filter(it => {
      const s = [
        it.company_id, it.company_name, it.subject,
        (it.matched_keywords||[]).join(" "),
        it.speech_date, it.speech_time,
        it.fetched_at_tw
      ].join(" ").toLowerCase();
      return s.includes(t);
    });
  }

  function renderDesktop(filtered){
    tbody.innerHTML = "";

    for (const it of filtered) {
      const tr = document.createElement("tr");

      // main row cells
      tr.innerHTML = `
        <td>${escapeHtml(it.speech_date || "")}</td>
        <td>${escapeHtml(it.speech_time || "")}</td>
        <td>
          <div class="company">
            <div class="id">${escapeHtml(it.company_id || "")}</div>
            <div class="name">${escapeHtml(it.company_name || "")}</div>
            <div class="fetched mono">${escapeHtml(it.fetched_at_tw || "")}</div>
          </div>
        </td>
        <td>${escapeHtml(it.subject || "")}</td>
        <td>${makeTagsHtml(it.matched_keywords)}</td>
        <td><button class="btn" data-key="${escapeHtml(it.key || "")}">å±•é–‹</button></td>
      `;

      // detail row (full width)
      const tr2 = document.createElement("tr");
      tr2.className = "detail-row";
      tr2.style.display = "none";
      tr2.setAttribute("data-detail-for", it.key || "");

      tr2.innerHTML = `
        <td colspan="6">
          <div class="detail-box">
            ${buildDetailTableHtml(it.detail)}
          </div>
        </td>
      `;

      tbody.appendChild(tr);
      tbody.appendChild(tr2);
    }

    // bind buttons
    tbody.querySelectorAll("button[data-key]").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-key");
        const row = tbody.querySelector(`tr.detail-row[data-detail-for="${CSS.escape(key)}"]`);
        if (!row) return;

        const open = row.style.display !== "none";
        row.style.display = open ? "none" : "table-row";
        btn.textContent = open ? "å±•é–‹" : "æ”¶èµ·";
      });
    });
  }

  function renderMobile(filtered){
    cards.innerHTML = "";

    for (const it of filtered) {
      const card = document.createElement("div");
      card.className = "card";

      const detailHtml = buildDetailTableHtml(it.detail);

      card.innerHTML = `
        <div class="top">
          <div>
            <div style="font-weight:800;">${escapeHtml(it.company_id || "")} ${escapeHtml(it.company_name || "")}</div>
            <div style="color:#666;font-size:12px;margin-top:2px;">${escapeHtml(it.speech_date || "")}</div>
          </div>
          <div class="time">${escapeHtml(it.speech_time || "")}</div>
        </div>

        <div class="subject">${escapeHtml(it.subject || "")}</div>

        <div style="margin-top:8px;">${makeTagsHtml(it.matched_keywords)}</div>

        <div class="meta2 mono">æŠ“å–æ™‚é–“ï¼š${escapeHtml(it.fetched_at_tw || "")}</div>

        <details>
          <summary>Detail</summary>
          ${detailHtml}
        </details>
      `;
      cards.appendChild(card);
    }
  }

  function render(){
    const term = (q.value || "").trim();
    const filtered = filterItems(term);

    stat.textContent = `é¡¯ç¤º ${filtered.length} / ${items.length}`;

    empty.style.display = filtered.length === 0 ? "block" : "none";

    renderDesktop(filtered);
    renderMobile(filtered);
  }

  q.addEventListener("input", render);
  render();
}

main().catch(err => {
  document.getElementById("meta").innerText = "è®€å–å¤±æ•—ï¼š" + err;
});
</script>

</body>
</html>

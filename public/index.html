<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MOPS é—œéµå­—å…¬å‘Šç›£æ§</title>

  <!-- favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png" />

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --border: rgba(255,255,255,.14);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    body {
      font-family: system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% 0%, #14214a 0%, rgba(20,33,74,0) 60%),
                  radial-gradient(900px 500px at 80% 10%, #163e3a 0%, rgba(22,62,58,0) 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 28px 18px 40px; }

    h1 { font-size: 22px; margin: 0 0 10px; letter-spacing: .2px; }
    .sub { color: var(--muted); line-height: 1.6; margin-bottom: 18px; }

    .bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin: 14px 0 14px;
    }

    .search {
      display: flex; gap: 10px; align-items: center;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      flex: 1 1 420px;
      min-width: 280px;
    }

    .search input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
    }

    .pill {
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: var(--card);
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      white-space: nowrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 12px 10px;
      vertical-align: top;
      font-size: 13px;
    }

    th {
      text-align: left;
      color: rgba(255,255,255,.85);
      background: rgba(255,255,255,.04);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 1;
    }

    tr:hover td { background: rgba(255,255,255,.03); }

    .company {
      display: grid;
      gap: 4px;
    }
    .company .id { font-weight: 650; }
    .company .name { color: var(--muted); font-size: 12px; }

    .kw {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .tag {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.85);
    }

    details {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
    }
    details summary {
      cursor: pointer;
      color: rgba(255,255,255,.9);
      user-select: none;
      font-weight: 600;
      outline: none;
    }
    details[open] summary { margin-bottom: 10px; }

    .detail-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
    }

    .detail-table th, .detail-table td {
      border-bottom: 1px solid var(--border);
      padding: 10px;
      font-size: 13px;
    }

    .detail-table th {
      width: 220px;
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .muted { color: var(--muted); }

    .empty {
      margin-top: 12px;
      padding: 14px 12px;
      border: 1px dashed var(--border);
      border-radius: 14px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>MOPS é—œéµå­—å…¬å‘Šç›£æ§</h1>
    <div class="sub" id="meta">è®€å–ä¸­...</div>

    <div class="bar">
      <div class="search">
        <span class="muted">ğŸ”</span>
        <input id="q" placeholder="æœå°‹ï¼šå…¬å¸ / ä¸»æ—¨ / é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šé´»æµ·ã€å…¬å¸å‚µã€è‡ªçµåˆä½µç‡Ÿæ”¶ï¼‰" />
      </div>
      <div class="pill" id="stat">â€”</div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 90px;">ç™¼è¨€æ—¥</th>
          <th style="width: 80px;">æ™‚é–“</th>
          <th style="width: 140px;">å…¬å¸</th>
          <th>ä¸»æ—¨</th>
          <th style="width: 190px;">å‘½ä¸­é—œéµå­—</th>
          <th style="width: 160px;">Detail</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div id="empty" class="empty" style="display:none;">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™ã€‚</div>
  </div>

<script>
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function nl2br(s) {
  // å…ˆ escape å†æ›è¡Œï¼Œé¿å… XSS
  const safe = escapeHtml(s);
  return safe.replaceAll("\n", "<br/>");
}

function safeGetDetailRow(detail) {
  // ä¾ä½ æä¾›çš„ detail çµæ§‹ï¼šdetail.result.data[0] æ˜¯ä¸€å€‹é™£åˆ—
  // [0]åºè™Ÿ [1]ç™¼è¨€æ—¥æœŸ [2]ç™¼è¨€æ™‚é–“ [3]ç™¼è¨€äºº [4]è·ç¨± [5]é›»è©± [6]ä¸»æ—¨ [7]ç¬¦åˆæ¢æ¬¾ [8]äº‹å¯¦ç™¼ç”Ÿæ—¥ [9]èªªæ˜
  try {
    const row = detail?.result?.data?.[0];
    if (Array.isArray(row) && row.length >= 10) return row;
  } catch (_) {}
  return null;
}

function getFetchedTs(it) {
  // fetched_at_tw: "YYYY-MM-DD HH:MM:SS"
  // Date.parse å°é€™ç¨®æ ¼å¼åœ¨ä¸åŒç€è¦½å™¨å¯èƒ½ä¸ç©©ï¼Œæ‰€ä»¥æ‰‹å‹•è½‰æˆ ISO
  const s = it?.fetched_at_tw;
  if (!s) return 0;
  const iso = s.replace(" ", "T") + "+08:00";
  const t = Date.parse(iso);
  return Number.isFinite(t) ? t : 0;
}

async function main() {
  const res = await fetch("./data.json", { cache: "no-store" });
  const data = await res.json();

  const meta = data.meta || {};
  let items = Array.isArray(data.items) ? data.items.slice() : [];

  // (2) æ’åºï¼šè¶Šæ™šæŠ“åˆ°è¶Šå‰é¢
  items.sort((a, b) => {
    const tb = getFetchedTs(b);
    const ta = getFetchedTs(a);
    if (tb !== ta) return tb - ta;
    // fallbackï¼škey åå‘ï¼ˆè¼ƒæ–°çš„é€šå¸¸ key ä¹Ÿä¸æœƒå°ï¼Œä½†ä¿éšªï¼‰
    return String(b?.key ?? "").localeCompare(String(a?.key ?? ""));
  });

  const metaEl = document.getElementById("meta");
  metaEl.innerHTML =
    `åŸ·è¡Œæ™‚é–“ï¼ˆå°ç£ï¼‰ï¼š<span class="mono">${escapeHtml(meta.run_at_tw || "-")}</span>
    ã€€ï½œã€€æŸ¥è©¢ï¼š<span class="mono">${escapeHtml(JSON.stringify(meta.query || {}))}</span>
    ã€€ï½œã€€é—œéµå­—ï¼š<span class="mono">${escapeHtml((meta.keywords || []).join(", "))}</span>`;

  const q = document.getElementById("q");
  const tbody = document.getElementById("tbody");
  const empty = document.getElementById("empty");
  const stat = document.getElementById("stat");

  function render() {
    const term = (q.value || "").trim().toLowerCase();
    tbody.innerHTML = "";

    const filtered = !term ? items : items.filter(it => {
      const s = [
        it.company_id, it.company_name, it.subject,
        (it.matched_keywords||[]).join(" "),
        it.speech_date, it.speech_time,
        it.fetched_at_tw
      ].join(" ").toLowerCase();
      return s.includes(term);
    });

    stat.textContent = `é¡¯ç¤º ${filtered.length} / ${items.length}`;

    if (filtered.length === 0) {
      empty.style.display = "block";
    } else {
      empty.style.display = "none";
    }

    for (const it of filtered) {
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = it.speech_date || "";
      tr.appendChild(tdDate);

      const tdTime = document.createElement("td");
      tdTime.textContent = it.speech_time || "";
      tr.appendChild(tdTime);

      const tdCo = document.createElement("td");
      tdCo.innerHTML = `
        <div class="company">
          <div class="id">${escapeHtml(it.company_id || "")}</div>
          <div class="name">${escapeHtml(it.company_name || "")}</div>
          <div class="muted mono" style="font-size:11px;">${escapeHtml(it.fetched_at_tw || "")}</div>
        </div>`;
      tr.appendChild(tdCo);

      const tdSub = document.createElement("td");
      tdSub.textContent = it.subject || "";
      tr.appendChild(tdSub);

      const tdKw = document.createElement("td");
      const kws = (it.matched_keywords || []).map(k => `<span class="tag">${escapeHtml(k)}</span>`).join("");
      tdKw.innerHTML = `<div class="kw">${kws || '<span class="muted">â€”</span>'}</div>`;
      tr.appendChild(tdKw);

      // (1) Detailï¼šæ”¹æˆå…©åˆ—è¡¨æ ¼é¡¯ç¤ºï¼ˆç™¼è¨€äºº(é›»è©±) / èªªæ˜ï¼‰
      const tdDetail = document.createElement("td");
      const d = document.createElement("details");
      const s = document.createElement("summary");
      s.textContent = "å±•é–‹";
      d.appendChild(s);

      const row = safeGetDetailRow(it.detail);
      if (row) {
        const speakerName = row[3] ?? "";
        const speakerTitle = row[4] ?? "";
        const speakerPhone = row[5] ?? "";
        const desc = row[9] ?? "";

        const speakerText = `${speakerName} ${speakerTitle}ï¼ˆ${speakerPhone}ï¼‰`.trim();

        d.innerHTML += `
          <table class="detail-table">
            <tr>
              <th>ç™¼è¨€äººï¼ˆé›»è©±ï¼‰</th>
              <th>èªªæ˜</th>
            </tr>
            <tr>
              <td>${escapeHtml(speakerText)}</td>
              <td>${nl2br(desc)}</td>
            </tr>
          </table>
        `;
      } else {
        d.innerHTML += `<div class="muted">ç„¡æ³•è§£æ detail çµæ§‹ï¼ˆå¯å…ˆæª¢æŸ¥ data.json çš„ detail.result.dataï¼‰</div>`;
      }

      tdDetail.appendChild(d);
      tr.appendChild(tdDetail);

      tbody.appendChild(tr);
    }
  }

  q.addEventListener("input", render);
  render();
}

main().catch(err => {
  document.getElementById("meta").innerText = "è®€å–å¤±æ•—ï¼š" + err;
});
</script>

</body>
</html>

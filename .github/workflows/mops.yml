name: MOPS Watcher

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Debug=>show commit + script hash
        run: |
          echo "SHA=${GITHUB_SHA}"
          git rev-parse HEAD
          git log -1 --oneline
          echo "---- fetch_mops.py line count + sha256 ----"
          wc -l scripts/fetch_mops.py
          sha256sum scripts/fetch_mops.py
          echo "---- show load_state lines ----"
          nl -ba scripts/fetch_mops.py | sed -n '50,90p'


      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch & build public data
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_TO: ${{ secrets.LINE_TO }}
        run: |
          python scripts/fetch_mops.py \
            --keywords keywords.txt \
            --out-json public/data.json \
            --out-csv public/data.csv \
            --state public/state.json

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data.json public/data.csv public/state.json
          git diff --cached --quiet || (git commit -m "Update MOPS data" && git push)
